// ▼▼▼ 【最终修复版】请用这个全新的、更健壮的函数，完整替换旧的 showChoiceModal ▼▼▼
/**
 * 【已修复】显示一个包含多个选项的操作菜单模态框
 * @param {string} title - 模态框的标题
 * @param {Array<object>} options - 按钮选项数组, e.g., [{ text: '按钮文字', value: '返回值' }]
 * @returns {Promise<string|null>} - 返回用户点击按钮的value，如果取消则返回null
 */
function showChoiceModal(title, options) {
    return new Promise(resolve => {
        const modal = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');

        // 1. 设置标题和清空内容区
        modalTitle.textContent = title;
        modalBody.innerHTML = ''; 
        
        // 2. 动态创建选项按钮
        modalFooter.innerHTML = ''; 
        modalFooter.style.flexDirection = 'column';

        options.forEach(option => {
            const button = document.createElement('button');
            button.textContent = option.text;
            button.onclick = () => {
                // 注意：这里我们不再调用 hideCustomModal，而是直接控制
                modal.classList.remove('visible');
                resolve(option.value);
            };
            modalFooter.appendChild(button);
        });

        // 3. 添加一个标准的取消按钮
        const cancelButton = document.createElement('button');
        cancelButton.textContent = '取消';
        cancelButton.style.marginTop = '8px';
        cancelButton.style.borderRadius = '8px';
        cancelButton.style.backgroundColor = '#f0f0f0';
        cancelButton.onclick = () => {
            modal.classList.remove('visible');
            resolve(null); // 用户取消，返回 null
        };
        modalFooter.appendChild(cancelButton);

        // 4. 显示模态框
        modal.classList.add('visible');

    }).finally(() => {
        // 5. 【【【这就是最关键的修复！】】】
        // 无论用户是选择了选项还是取消，最后都【必须】将模态框的页脚恢复为原始的、功能完整的状态。
        const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');

        modalFooter.style.flexDirection = 'row'; // 恢复水平布局
        // 重新创建原始的“取消”和“确定”按钮
        modalFooter.innerHTML = `
            <button id="custom-modal-cancel">取消</button>
            <button id="custom-modal-confirm" class="confirm-btn">确定</button>
        `;

        // 【重要】为新创建的按钮重新绑定它们最基本的默认事件！
        document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
        // 注意：我们不需要为“确定”按钮绑定默认事件，因为 showCustomConfirm 和 showCustomPrompt 
        // 每次调用时都会为它动态绑定新的 onclick 事件，这正是我们想要的行为。
    });
}
// ▲▲▲ 替换结束 ▲▲▲

